name: Update 

on:
  # å®šæ—¶ä»»åŠ¡ï¼ˆé»˜è®¤ç¦ç”¨ï¼Œå–æ¶ˆæ³¨é‡Šå³å¯å¯ç”¨ï¼‰
  # GitHub Actions å®šæ—¶å¯èƒ½æœ‰ 10-60 åˆ†é’Ÿå»¶è¿Ÿ
  # schedule:
  #   - cron: '0 16,20,0,4,8,12 * * *'  # UTC æ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬ 0,4,8,12,16,20 ç‚¹
  workflow_dispatch:

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: write-all
    outputs:
      changes: ${{ steps.check_changes.outputs.changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Set up Python 3.14
        uses: actions/setup-python@v6
        with:
          python-version: 3.14
          cache: 'pip'  # å¯ç”¨ä¾èµ–ç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æ„å»º

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Clone page branch
        run: |
          # å…‹éš†ä»“åº“ï¼ˆä»…å…‹éš†æœ€æ–°ç‰ˆæœ¬ï¼‰
          git clone --depth=1 --branch=page https://github.com/${{ github.repository }}.git /tmp/repo
          # å¤åˆ¶ data æ–‡ä»¶å¤¹å†…å®¹åˆ°ç›®æ ‡ç›®å½•
          cp -r /tmp/repo/data/* ./page/data/
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/repo

      - name: Decrypt tokens.enc if exists
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          if [ -f "./page/data/tokens.enc" ]; then
            echo "ğŸ” è§£å¯† tokens.enc ..."
            python3 ./crypto.py decrypt || echo "âš ï¸ è§£å¯†å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œ"
          else
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°åŠ å¯†æ–‡ä»¶ï¼Œè·³è¿‡è§£å¯†æ­¥éª¤"
          fi
          
      - name: Run python script
        env:
          ACCOUNT: ${{ secrets.ACCOUNT }}
          PASSWORD: ${{ secrets.PASSWORD }}
          LIGHT_ROOM: ${{ secrets.LIGHT_ROOM }}
          AC_ROOM: ${{ secrets.AC_ROOM }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          SERVERCHAN_KEYS: ${{ secrets.SERVERCHAN_KEY }},${{ secrets.SERVERCHAN_KEY2 }},${{ secrets.SERVERCHAN_KEY3 }}
          EMAIL: ${{ secrets.EMAIL }}
          SMTP_CODE: ${{ secrets.SMTP_CODE }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        run: |
          python3 ./main.py
          python3 ./markdown.py >> $GITHUB_STEP_SUMMARY

      - name: Encrypt tokens.json
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          if [ -f "./page/data/tokens.json" ]; then
            echo "ğŸ” åŠ å¯† tokens.json ..."
            python3 ./crypto.py encrypt
            echo "ğŸ§¹ åˆ é™¤åŸå§‹ tokens.json ..."
            rm -f ./page/data/tokens.json
          else
            echo "âš ï¸ æœªæ‰¾åˆ° tokens.jsonï¼Œè·³è¿‡åŠ å¯†æ­¥éª¤"
          fi

      - name: git config
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Commit changes
        run: |
          mkdir pages
          cp -r ./page/data ./page/favicon.ico ./page/index.html ./page/style.css ./page/README.md  pages/
          cd pages
          git init
          git add .
          git commit -m "â±ï¸ $(date +"%Yå¹´%mæœˆ%dæ—¥-%Hæ—¶%Måˆ†") GitHub Actionså®šæ—¶æ›´æ–°"
          git push --force https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:page

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: './page'
  
      - name: Delete Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 30
          keep_minimum_runs: 6


  deploy:
    needs: build
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4


  keepalive-workflow:
    name: Keepalive Workflow
    if: ${{ always() }}
    needs: build
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Keep workflow active
        uses: liskin/gh-workflow-keepalive@v1
